<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Create trainers table -->
    <changeSet id="023-01-create-trainers-table" author="hrms">
        <createTable tableName="trainers">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(200)"/>
            <column name="phone" type="VARCHAR(50)"/>
            <column name="specialization" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="organization" type="VARCHAR(300)"/>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="personnel_id" type="BIGINT"/>
            <column name="qualifications" type="TEXT"/>
            <column name="experience_years" type="INTEGER"/>
            <column name="hourly_rate" type="NUMERIC(15,2)"/>
            <column name="currency" type="VARCHAR(3)" defaultValue="XAF"/>
            <column name="notes" type="TEXT"/>
            <column name="active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="trainers" baseColumnNames="personnel_id"
                                 constraintName="fk_trainer_personnel"
                                 referencedTableName="personnel" referencedColumnNames="id"/>
        <createIndex indexName="idx_trainer_code" tableName="trainers">
            <column name="code"/>
        </createIndex>
        <createIndex indexName="idx_trainer_type" tableName="trainers">
            <column name="type"/>
        </createIndex>
        <createIndex indexName="idx_trainer_active" tableName="trainers">
            <column name="active"/>
        </createIndex>
    </changeSet>

    <!-- Create trainings table -->
    <changeSet id="023-02-create-trainings-table" author="hrms">
        <createTable tableName="trainings">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(300)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="training_field" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="duration_days" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="objectives" type="TEXT"/>
            <column name="prerequisites" type="TEXT"/>
            <column name="content" type="TEXT"/>
            <column name="pedagogical_methods" type="TEXT"/>
            <column name="category" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="required_level" type="VARCHAR(50)"/>
            <column name="standard_cost_per_participant" type="NUMERIC(15,2)"/>
            <column name="min_participants" type="INTEGER"/>
            <column name="max_participants" type="INTEGER"/>
            <column name="active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_training_code" tableName="trainings">
            <column name="code"/>
        </createIndex>
        <createIndex indexName="idx_training_category" tableName="trainings">
            <column name="category"/>
        </createIndex>
        <createIndex indexName="idx_training_active" tableName="trainings">
            <column name="active"/>
        </createIndex>
    </changeSet>

    <!-- Create training_sessions table -->
    <changeSet id="023-03-create-training-sessions-table" author="hrms">
        <createTable tableName="training_sessions">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="training_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(50)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(300)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="location" type="VARCHAR(300)">
                <constraints nullable="false"/>
            </column>
            <column name="max_participants" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="min_participants" type="INTEGER"/>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="trainer_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="organizing_structure_id" type="BIGINT"/>
            <column name="total_cost" type="NUMERIC(15,2)"/>
            <column name="cost_per_participant" type="NUMERIC(15,2)"/>
            <column name="budget" type="NUMERIC(15,2)"/>
            <column name="description" type="TEXT"/>
            <column name="notes" type="TEXT"/>
            <column name="enrollment_start_date" type="DATE"/>
            <column name="enrollment_end_date" type="DATE"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="training_sessions" baseColumnNames="training_id"
                                 constraintName="fk_session_training"
                                 referencedTableName="trainings" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="training_sessions" baseColumnNames="trainer_id"
                                 constraintName="fk_session_trainer"
                                 referencedTableName="trainers" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="training_sessions" baseColumnNames="organizing_structure_id"
                                 constraintName="fk_session_structure"
                                 referencedTableName="administrative_structures" referencedColumnNames="id"/>
        <createIndex indexName="idx_session_code" tableName="training_sessions">
            <column name="code"/>
        </createIndex>
        <createIndex indexName="idx_session_training" tableName="training_sessions">
            <column name="training_id"/>
        </createIndex>
        <createIndex indexName="idx_session_trainer" tableName="training_sessions">
            <column name="trainer_id"/>
        </createIndex>
        <createIndex indexName="idx_session_status" tableName="training_sessions">
            <column name="status"/>
        </createIndex>
        <createIndex indexName="idx_session_dates" tableName="training_sessions">
            <column name="start_date"/>
            <column name="end_date"/>
        </createIndex>
    </changeSet>

    <!-- Create training_session_co_trainers junction table -->
    <changeSet id="023-04-create-session-co-trainers-table" author="hrms">
        <createTable tableName="training_session_co_trainers">
            <column name="session_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="trainer_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="training_session_co_trainers" columnNames="session_id, trainer_id"/>
        <addForeignKeyConstraint baseTableName="training_session_co_trainers" baseColumnNames="session_id"
                                 constraintName="fk_co_trainers_session"
                                 referencedTableName="training_sessions" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="training_session_co_trainers" baseColumnNames="trainer_id"
                                 constraintName="fk_co_trainers_trainer"
                                 referencedTableName="trainers" referencedColumnNames="id"/>
    </changeSet>

    <!-- Create training_enrollments table -->
    <changeSet id="023-05-create-training-enrollments-table" author="hrms">
        <createTable tableName="training_enrollments">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="personnel_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="enrollment_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="approval_date" type="DATE"/>
            <column name="approved_by" type="VARCHAR(100)"/>
            <column name="rejection_reason" type="TEXT"/>
            <column name="certificate_issued" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="certificate_number" type="VARCHAR(100)"/>
            <column name="certificate_date" type="DATE"/>
            <column name="evaluation" type="TEXT"/>
            <column name="score" type="INTEGER"/>
            <column name="attendance_rate" type="DOUBLE PRECISION"/>
            <column name="notes" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="training_enrollments" baseColumnNames="session_id"
                                 constraintName="fk_enrollment_session"
                                 referencedTableName="training_sessions" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="training_enrollments" baseColumnNames="personnel_id"
                                 constraintName="fk_enrollment_personnel"
                                 referencedTableName="personnel" referencedColumnNames="id"/>
        <addUniqueConstraint tableName="training_enrollments" columnNames="session_id, personnel_id"
                            constraintName="uk_enrollment_session_personnel"/>
        <createIndex indexName="idx_enrollment_session" tableName="training_enrollments">
            <column name="session_id"/>
        </createIndex>
        <createIndex indexName="idx_enrollment_personnel" tableName="training_enrollments">
            <column name="personnel_id"/>
        </createIndex>
        <createIndex indexName="idx_enrollment_status" tableName="training_enrollments">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- Create training_costs table -->
    <changeSet id="023-06-create-training-costs-table" author="hrms">
        <createTable tableName="training_costs">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="session_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cost_type" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="NUMERIC(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="currency" type="VARCHAR(3)" defaultValue="XAF">
                <constraints nullable="false"/>
            </column>
            <column name="expense_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_number" type="VARCHAR(100)"/>
            <column name="payment_status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_date" type="DATE"/>
            <column name="supplier" type="VARCHAR(300)"/>
            <column name="notes" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="updated_by" type="VARCHAR(100)"/>
            <column name="deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted_at" type="TIMESTAMP"/>
            <column name="deleted_by" type="VARCHAR(100)"/>
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="training_costs" baseColumnNames="session_id"
                                 constraintName="fk_cost_session"
                                 referencedTableName="training_sessions" referencedColumnNames="id"/>
        <createIndex indexName="idx_cost_session" tableName="training_costs">
            <column name="session_id"/>
        </createIndex>
        <createIndex indexName="idx_cost_type" tableName="training_costs">
            <column name="cost_type"/>
        </createIndex>
        <createIndex indexName="idx_cost_payment_status" tableName="training_costs">
            <column name="payment_status"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>




