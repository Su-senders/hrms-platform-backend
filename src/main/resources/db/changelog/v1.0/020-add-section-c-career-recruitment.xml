<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!--
        Migration 020: Section C - Carrière : Situation au Recrutement
        - Ajout des champs relatifs à l'acte de recrutement
        - Ajout des champs relatifs au mode et aux conditions de recrutement
    -->

    <!-- Changeset 1: Ajouter les champs de l'acte de recrutement -->
    <changeSet id="020-1" author="system">
        <comment>
            Ajouter les informations relatives à l'acte de recrutement
        </comment>

        <addColumn tableName="personnel">
            <!-- Numéro d'acte de recrutement -->
            <column name="recruitment_act_number" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>

            <!-- Nature de l'acte de recrutement -->
            <column name="recruitment_act_nature" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Date de signature de l'acte -->
            <column name="recruitment_act_signature_date" type="DATE">
                <constraints nullable="true"/>
            </column>

            <!-- Signataire de l'acte -->
            <column name="recruitment_act_signatory" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>

            <!-- Date de prise d'effet -->
            <column name="recruitment_act_effective_date" type="DATE">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="recruitment_act_number"/>
            <dropColumn tableName="personnel" columnName="recruitment_act_nature"/>
            <dropColumn tableName="personnel" columnName="recruitment_act_signature_date"/>
            <dropColumn tableName="personnel" columnName="recruitment_act_signatory"/>
            <dropColumn tableName="personnel" columnName="recruitment_act_effective_date"/>
        </rollback>
    </changeSet>

    <!-- Changeset 2: Ajouter les champs du mode et conditions de recrutement -->
    <changeSet id="020-2" author="system">
        <comment>
            Ajouter le mode de recrutement, la profession, la catégorie et l'administration d'origine
        </comment>

        <addColumn tableName="personnel">
            <!-- Mode de recrutement -->
            <column name="recruitment_mode" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Profession au recrutement -->
            <column name="recruitment_profession" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>

            <!-- Catégorie au recrutement -->
            <column name="recruitment_category" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Administration d'origine -->
            <column name="origin_administration" type="VARCHAR(300)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="recruitment_mode"/>
            <dropColumn tableName="personnel" columnName="recruitment_profession"/>
            <dropColumn tableName="personnel" columnName="recruitment_category"/>
            <dropColumn tableName="personnel" columnName="origin_administration"/>
        </rollback>
    </changeSet>

    <!-- Changeset 3: Ajouter des index pour les recherches -->
    <changeSet id="020-3" author="system">
        <comment>
            Ajouter des index pour améliorer les performances de recherche
        </comment>

        <!-- Index sur recruitment_act_nature -->
        <createIndex indexName="idx_personnel_recruitment_act_nature" tableName="personnel">
            <column name="recruitment_act_nature"/>
        </createIndex>

        <!-- Index sur recruitment_mode -->
        <createIndex indexName="idx_personnel_recruitment_mode" tableName="personnel">
            <column name="recruitment_mode"/>
        </createIndex>

        <!-- Index sur recruitment_category -->
        <createIndex indexName="idx_personnel_recruitment_category" tableName="personnel">
            <column name="recruitment_category"/>
        </createIndex>

        <!-- Index sur recruitment_act_effective_date -->
        <createIndex indexName="idx_personnel_recruitment_act_effective_date" tableName="personnel">
            <column name="recruitment_act_effective_date"/>
        </createIndex>

        <rollback>
            <dropIndex indexName="idx_personnel_recruitment_act_nature" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_recruitment_mode" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_recruitment_category" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_recruitment_act_effective_date" tableName="personnel"/>
        </rollback>
    </changeSet>

    <!-- Changeset 4: Contraintes CHECK pour les dates -->
    <changeSet id="020-4" author="system" dbms="postgresql,mysql,h2">
        <comment>
            S'assurer que les dates de l'acte de recrutement sont cohérentes
        </comment>

        <!-- Date de signature doit être >= 1960-01-01 et >= date de naissance -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_recruitment_act_signature_date
            CHECK (
                recruitment_act_signature_date IS NULL OR
                (recruitment_act_signature_date >= date_of_birth AND recruitment_act_signature_date >= '1960-01-01')
            );
        </sql>

        <!-- Date de prise d'effet doit être >= date de signature -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_recruitment_act_effective_date
            CHECK (
                recruitment_act_effective_date IS NULL OR
                recruitment_act_effective_date >= '1960-01-01'
            );
        </sql>

        <rollback>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_recruitment_act_signature_date;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_recruitment_act_effective_date;
            </sql>
        </rollback>
    </changeSet>

    <!-- Changeset 5: Contraintes CHECK pour les enums -->
    <changeSet id="020-5" author="system" dbms="postgresql,mysql,h2">
        <comment>
            S'assurer que les valeurs d'enums sont valides
        </comment>

        <!-- Nature de l'acte de recrutement -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_recruitment_act_nature
            CHECK (
                recruitment_act_nature IS NULL OR
                recruitment_act_nature IN ('DECRET', 'ARRETE', 'DECISION', 'CONTRAT_TRAVAIL', 'AUTRE')
            );
        </sql>

        <!-- Mode de recrutement -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_recruitment_mode
            CHECK (
                recruitment_mode IS NULL OR
                recruitment_mode IN ('SUR_CONCOURS', 'SUR_TITRE', 'SPECIAL', 'CONTRACTUEL', 'INTEGRATION', 'MUTATION', 'AUTRE')
            );
        </sql>

        <!-- Catégorie du personnel -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_recruitment_category
            CHECK (
                recruitment_category IS NULL OR
                recruitment_category IN ('CATEGORIE_A', 'CATEGORIE_B', 'CATEGORIE_C', 'CATEGORIE_D', 'HORS_CATEGORIE')
            );
        </sql>

        <rollback>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_recruitment_act_nature;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_recruitment_mode;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_recruitment_category;
            </sql>
        </rollback>
    </changeSet>

    <!-- Changeset 6: Commentaires sur les colonnes (PostgreSQL) -->
    <changeSet id="020-6" author="system" dbms="postgresql">
        <sql>
            COMMENT ON COLUMN personnel.recruitment_act_number IS 'Numéro de l''acte de recrutement (ex: Décret N° 2020/456)';
            COMMENT ON COLUMN personnel.recruitment_act_nature IS 'Nature de l''acte: DECRET, ARRETE, DECISION, CONTRAT_TRAVAIL';
            COMMENT ON COLUMN personnel.recruitment_act_signature_date IS 'Date de signature de l''acte de recrutement';
            COMMENT ON COLUMN personnel.recruitment_act_signatory IS 'Signataire de l''acte (Ministre, Délégué, etc.)';
            COMMENT ON COLUMN personnel.recruitment_act_effective_date IS 'Date de prise d''effet de l''acte de recrutement';
            COMMENT ON COLUMN personnel.recruitment_mode IS 'Mode de recrutement: SUR_CONCOURS, SUR_TITRE, SPECIAL';
            COMMENT ON COLUMN personnel.recruitment_profession IS 'Profession au moment du recrutement';
            COMMENT ON COLUMN personnel.recruitment_category IS 'Catégorie au recrutement: A, B, C, D, HORS_CATEGORIE';
            COMMENT ON COLUMN personnel.origin_administration IS 'Administration d''origine avant recrutement au MINAT';
        </sql>

        <rollback>
            <sql>
                COMMENT ON COLUMN personnel.recruitment_act_number IS NULL;
                COMMENT ON COLUMN personnel.recruitment_act_nature IS NULL;
                COMMENT ON COLUMN personnel.recruitment_act_signature_date IS NULL;
                COMMENT ON COLUMN personnel.recruitment_act_signatory IS NULL;
                COMMENT ON COLUMN personnel.recruitment_act_effective_date IS NULL;
                COMMENT ON COLUMN personnel.recruitment_mode IS NULL;
                COMMENT ON COLUMN personnel.recruitment_profession IS NULL;
                COMMENT ON COLUMN personnel.recruitment_category IS NULL;
                COMMENT ON COLUMN personnel.origin_administration IS NULL;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
