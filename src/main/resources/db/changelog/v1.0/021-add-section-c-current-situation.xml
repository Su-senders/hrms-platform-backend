<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!--
        Migration 021: Section C - Carrière : Situation Actuelle
        - Ajout de l'ancienneté dans l'administration publique (Section C.2)
        - Ajout des champs de la situation actuelle (Section C.3)
    -->

    <!-- Changeset 1: Ajouter l'ancienneté dans l'administration publique -->
    <changeSet id="021-1" author="system">
        <comment>
            Ajouter le champ d'ancienneté dans l'administration publique (calculé automatiquement)
        </comment>

        <addColumn tableName="personnel">
            <!-- Ancienneté en années (calculée automatiquement) -->
            <column name="years_in_public_service" type="INTEGER">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="years_in_public_service"/>
        </rollback>
    </changeSet>

    <!-- Changeset 2: Ajouter les champs du texte accordant la situation actuelle -->
    <changeSet id="021-2" author="system">
        <comment>
            Ajouter les informations relatives au texte accordant la situation actuelle
        </comment>

        <addColumn tableName="personnel">
            <!-- Numéro du texte accordant -->
            <column name="current_act_number" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>

            <!-- Nature du texte accordant -->
            <column name="current_act_nature" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Date de signature -->
            <column name="current_act_signature_date" type="DATE">
                <constraints nullable="true"/>
            </column>

            <!-- Signataire -->
            <column name="current_act_signatory" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>

            <!-- Date de prise d'effet -->
            <column name="current_act_effective_date" type="DATE">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="current_act_number"/>
            <dropColumn tableName="personnel" columnName="current_act_nature"/>
            <dropColumn tableName="personnel" columnName="current_act_signature_date"/>
            <dropColumn tableName="personnel" columnName="current_act_signatory"/>
            <dropColumn tableName="personnel" columnName="current_act_effective_date"/>
        </rollback>
    </changeSet>

    <!-- Changeset 3: Ajouter le type de personnel et la classe -->
    <changeSet id="021-3" author="system">
        <comment>
            Ajouter le type de personnel (fonctionnaire, contractuel, décisionnaire) et la classe
        </comment>

        <addColumn tableName="personnel">
            <!-- Type de personnel -->
            <column name="personnel_type" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Classe -->
            <column name="classe" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="personnel_type"/>
            <dropColumn tableName="personnel" columnName="classe"/>
        </rollback>
    </changeSet>

    <!-- Changeset 4: Ajouter les champs de l'acte de nomination -->
    <changeSet id="021-4" author="system">
        <comment>
            Ajouter les informations relatives à l'acte de nomination au poste actuel
        </comment>

        <addColumn tableName="personnel">
            <!-- Numéro d'acte de nomination -->
            <column name="appointment_act_number" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>

            <!-- Nature de l'acte de nomination -->
            <column name="appointment_act_nature" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Date de nomination -->
            <column name="appointment_act_date" type="DATE">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="appointment_act_number"/>
            <dropColumn tableName="personnel" columnName="appointment_act_nature"/>
            <dropColumn tableName="personnel" columnName="appointment_act_date"/>
        </rollback>
    </changeSet>

    <!-- Changeset 5: Ajouter les autres fonctions actuelles -->
    <changeSet id="021-5" author="system">
        <comment>
            Ajouter les champs pour les autres fonctions actuelles (PCA, Président de commission, etc.)
        </comment>

        <addColumn tableName="personnel">
            <!-- Fonction actuelle 1 -->
            <column name="current_other_function_1" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>

            <!-- Fonction actuelle 2 -->
            <column name="current_other_function_2" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>

            <!-- Fonction actuelle 3 -->
            <column name="current_other_function_3" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <rollback>
            <dropColumn tableName="personnel" columnName="current_other_function_1"/>
            <dropColumn tableName="personnel" columnName="current_other_function_2"/>
            <dropColumn tableName="personnel" columnName="current_other_function_3"/>
        </rollback>
    </changeSet>

    <!-- Changeset 6: Ajouter des index pour les recherches -->
    <changeSet id="021-6" author="system">
        <comment>
            Ajouter des index pour améliorer les performances de recherche
        </comment>

        <!-- Index sur current_act_nature -->
        <createIndex indexName="idx_personnel_current_act_nature" tableName="personnel">
            <column name="current_act_nature"/>
        </createIndex>

        <!-- Index sur personnel_type -->
        <createIndex indexName="idx_personnel_type" tableName="personnel">
            <column name="personnel_type"/>
        </createIndex>

        <!-- Index sur appointment_act_nature -->
        <createIndex indexName="idx_personnel_appointment_act_nature" tableName="personnel">
            <column name="appointment_act_nature"/>
        </createIndex>

        <!-- Index sur current_act_effective_date -->
        <createIndex indexName="idx_personnel_current_act_effective_date" tableName="personnel">
            <column name="current_act_effective_date"/>
        </createIndex>

        <rollback>
            <dropIndex indexName="idx_personnel_current_act_nature" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_type" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_appointment_act_nature" tableName="personnel"/>
            <dropIndex indexName="idx_personnel_current_act_effective_date" tableName="personnel"/>
        </rollback>
    </changeSet>

    <!-- Changeset 7: Contraintes CHECK pour les dates -->
    <changeSet id="021-7" author="system" dbms="postgresql,mysql,h2">
        <comment>
            S'assurer que les dates sont cohérentes
        </comment>

        <!-- Date de signature du texte accordant >= 1960-01-01 -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_current_act_signature_date
            CHECK (
                current_act_signature_date IS NULL OR
                current_act_signature_date >= '1960-01-01'
            );
        </sql>

        <!-- Date de prise d'effet du texte accordant >= 1960-01-01 -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_current_act_effective_date
            CHECK (
                current_act_effective_date IS NULL OR
                current_act_effective_date >= '1960-01-01'
            );
        </sql>

        <!-- Date de nomination >= 1960-01-01 -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_appointment_act_date
            CHECK (
                appointment_act_date IS NULL OR
                appointment_act_date >= '1960-01-01'
            );
        </sql>

        <rollback>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_current_act_signature_date;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_current_act_effective_date;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_appointment_act_date;
            </sql>
        </rollback>
    </changeSet>

    <!-- Changeset 8: Contraintes CHECK pour les enums -->
    <changeSet id="021-8" author="system" dbms="postgresql,mysql,h2">
        <comment>
            S'assurer que les valeurs d'enums sont valides
        </comment>

        <!-- Nature du texte accordant -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_current_act_nature
            CHECK (
                current_act_nature IS NULL OR
                current_act_nature IN ('ACTE_INTEGRATION', 'AVANCE_GRADE', 'CONTRAT_TRAVAIL',
                                      'ACTE_RECLASSEMENT', 'AVENANT_CONTRAT', 'DECISION', 'AUTRE')
            );
        </sql>

        <!-- Type de personnel -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_type
            CHECK (
                personnel_type IS NULL OR
                personnel_type IN ('FONCTIONNAIRE', 'CONTRACTUEL', 'DECISIONNAIRE', 'STAGIAIRE', 'AUTRE')
            );
        </sql>

        <!-- Nature de l'acte de nomination -->
        <sql>
            ALTER TABLE personnel ADD CONSTRAINT chk_personnel_appointment_act_nature
            CHECK (
                appointment_act_nature IS NULL OR
                appointment_act_nature IN ('DECRET', 'ARRETE', 'DECISION', 'AUTRE')
            );
        </sql>

        <rollback>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_current_act_nature;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_type;
            </sql>
            <sql>
                ALTER TABLE personnel DROP CONSTRAINT IF EXISTS chk_personnel_appointment_act_nature;
            </sql>
        </rollback>
    </changeSet>

    <!-- Changeset 9: Commentaires sur les colonnes (PostgreSQL) -->
    <changeSet id="021-9" author="system" dbms="postgresql">
        <sql>
            COMMENT ON COLUMN personnel.years_in_public_service IS 'Ancienneté dans l''administration publique (en années, calculée automatiquement)';

            COMMENT ON COLUMN personnel.current_act_number IS 'Numéro du texte accordant la situation actuelle';
            COMMENT ON COLUMN personnel.current_act_nature IS 'Nature du texte: ACTE_INTEGRATION, AVANCE_GRADE, CONTRAT_TRAVAIL, etc.';
            COMMENT ON COLUMN personnel.current_act_signature_date IS 'Date de signature du texte accordant';
            COMMENT ON COLUMN personnel.current_act_signatory IS 'Signataire du texte accordant';
            COMMENT ON COLUMN personnel.current_act_effective_date IS 'Date de prise d''effet du texte accordant';

            COMMENT ON COLUMN personnel.personnel_type IS 'Type de personnel: FONCTIONNAIRE, CONTRACTUEL, DECISIONNAIRE, STAGIAIRE';
            COMMENT ON COLUMN personnel.classe IS 'Classe du personnel (ex: Classe Exceptionnelle, Classe Normale, Hors Classe)';

            COMMENT ON COLUMN personnel.appointment_act_number IS 'Numéro de l''acte de nomination au poste actuel';
            COMMENT ON COLUMN personnel.appointment_act_nature IS 'Nature de l''acte de nomination: DECRET, ARRETE, DECISION';
            COMMENT ON COLUMN personnel.appointment_act_date IS 'Date de nomination au poste actuel';

            COMMENT ON COLUMN personnel.current_other_function_1 IS 'Autre fonction actuelle 1 (ex: PCA, Président de commission)';
            COMMENT ON COLUMN personnel.current_other_function_2 IS 'Autre fonction actuelle 2';
            COMMENT ON COLUMN personnel.current_other_function_3 IS 'Autre fonction actuelle 3';
        </sql>

        <rollback>
            <sql>
                COMMENT ON COLUMN personnel.years_in_public_service IS NULL;
                COMMENT ON COLUMN personnel.current_act_number IS NULL;
                COMMENT ON COLUMN personnel.current_act_nature IS NULL;
                COMMENT ON COLUMN personnel.current_act_signature_date IS NULL;
                COMMENT ON COLUMN personnel.current_act_signatory IS NULL;
                COMMENT ON COLUMN personnel.current_act_effective_date IS NULL;
                COMMENT ON COLUMN personnel.personnel_type IS NULL;
                COMMENT ON COLUMN personnel.classe IS NULL;
                COMMENT ON COLUMN personnel.appointment_act_number IS NULL;
                COMMENT ON COLUMN personnel.appointment_act_nature IS NULL;
                COMMENT ON COLUMN personnel.appointment_act_date IS NULL;
                COMMENT ON COLUMN personnel.current_other_function_1 IS NULL;
                COMMENT ON COLUMN personnel.current_other_function_2 IS NULL;
                COMMENT ON COLUMN personnel.current_other_function_3 IS NULL;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
